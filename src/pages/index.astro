---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import HeroSlider from '../components/movie/HeroSlider.astro';
import MovieCarousel from '../components/movie/MovieCarousel.astro';
import ContinueWatchingCarousel from '../components/movie/ContinueWatchingCarousel.astro';
import RankingCarousel from '../components/movie/RankingCarousel.astro';
import SmallCarousel from '../components/movie/SmallCarousel.astro';
import GenreExplorer from '../components/movie/GenreExplorer.astro';
import StreamingLogos from '../components/movie/StreamingLogos.astro';
import { getNewUpdatedMovies, getMoviesByCategory, getImageUrl, type Movie } from '../lib/movieService';
import { MOVIE_GENRES } from '../lib/constants';

// Fetch data from API
const newMoviesRes = await getNewUpdatedMovies(1) as any;
const singleMoviesRes = await getMoviesByCategory('phim-le', 1, 12);
const seriesMoviesRes = await getMoviesByCategory('phim-bo', 1, 12);
const animationRes = await getMoviesByCategory('hoat-hinh', 1, 12);
const tvShowsRes = await getMoviesByCategory('tv-shows', 1, 12);

// Extract items from responses
const newMovies = newMoviesRes?.items || [];
const singleMovies = singleMoviesRes?.data?.items || [];
const seriesMovies = seriesMoviesRes?.data?.items || [];
const animationMovies = animationRes?.data?.items || [];
const tvShows = tvShowsRes?.data?.items || [];

// Prepare slides for HeroSlider (first 5 movies)
const heroSlides = newMovies.slice(0, 5).map((movie: any, index: number) => ({
  id: movie.slug,
  title: movie.name,
  year: movie.year || 2024,
  rating: 8.0 + Math.random() * 1.5,
  duration: movie.time || "2h 30m",
  genres: movie.category?.slice(0, 2).map((c: any) => c.name) || [],
  synopsis: movie.content || (lang === 'vi' ? "Khám phá bộ phim hấp dẫn này với những tình tiết gay cấn và diễn xuất xuất sắc." : "Explore this exciting movie with thrilling scenes and outstanding performances."),
  backdrop: getImageUrl(movie.thumb_url || movie.poster_url),
  season: index === 0 ? (lang === 'vi' ? "Mùa 3" : "Season 3") : undefined,
}));

// Prepare genres with movies for GenreExplorer
// Use movies from different categories to simulate genre-based grouping
const allMoviesPool = [...singleMovies, ...seriesMovies, ...animationMovies, ...tvShows, ...newMovies];
const genresWithMovies = MOVIE_GENRES.slice(0, 8).map((genre, index) => {
  // Distribute movies across genres for demonstration
  const startIndex = (index * 3) % allMoviesPool.length;
  const genreMovies = allMoviesPool.slice(startIndex, startIndex + 5);
  return {
    name: genre.name,
    slug: genre.slug,
    movies: genreMovies.length > 0 ? genreMovies : allMoviesPool.slice(0, 5),
  };
});

// Get translations
import { useTranslations } from '../lib/useTranslations';
const langCookie = Astro.cookies.get('language');
const { translations, lang } = useTranslations(langCookie?.value);
---

<BaseLayout title={lang === 'vi' ? "Movie247 - Xem Phim Online Chất Lượng Cao" : "Movie247 - Watch High Quality Movies Online"}>
  <Header isTransparent={true} />
  
  <main>
    <!-- Hero Slider -->
    {heroSlides.length > 0 && (
      <HeroSlider movies={heroSlides} />
    )}

    <!-- Streaming Logos -->
    <StreamingLogos />

    <!-- Content Sections -->
    <div class="home-content">
      <!-- Continue Watching (16:9 cards with progress bar) -->
      {newMovies.length > 0 && (
        <ContinueWatchingCarousel 
          title={translations.categories.continueWatching}
          movies={newMovies.slice(0, 6)}
          viewAllLink="/history"
        />
      )}

      <!-- Popular of the Week (Numbered ranking) -->
      {singleMovies.length > 0 && (
        <RankingCarousel 
          title={translations.categories.popularThisWeek}
          movies={singleMovies}
          viewAllLink="/movies?sort=popular"
        />
      )}

      <!-- Just Release (Standard cards) -->
      {newMovies.length > 0 && (
        <MovieCarousel 
          title={translations.categories.newUpdates}
          movies={newMovies}
          viewAllLink="/movies"
          useApi={true}
        />
      )}

      <!-- Your Watchlist (Smaller cards) -->
      {seriesMovies.length > 0 && (
        <SmallCarousel 
          title={translations.categories.yourWatchlist}
          movies={seriesMovies}
          viewAllLink="/watchlist"
        />
      )}

      <!-- Genre Explorer with Movie Backdrops -->
      <GenreExplorer 
        title={translations.hero.exploreByGenre}
        genresWithMovies={genresWithMovies}
      />

      <!-- Your Likes (Smaller cards with ratings) -->
      {animationMovies.length > 0 && (
        <SmallCarousel 
          title={translations.categories.yourLikes}
          movies={animationMovies}
          viewAllLink="/recommendations"
        />
      )}

      <!-- Phim Bộ (Standard cards) -->
      {seriesMovies.length > 0 && (
        <MovieCarousel 
          title={translations.nav.tvShows}
          movies={seriesMovies}
          viewAllLink="/tv-shows"
          useApi={true}
        />
      )}

      <!-- Hoạt Hình -->
      {animationMovies.length > 0 && (
        <MovieCarousel 
          title={translations.nav.animation}
          movies={animationMovies}
          viewAllLink="/movies?category=hoat-hinh"
          useApi={true}
        />
      )}
    </div>
  </main>


  <Footer />
</BaseLayout>


<style>
  .home-content {
    padding-top: var(--spacing-lg);
    padding-bottom: var(--spacing-xl);
  }

  /* Responsive spacing adjustments */
  @media (max-width: 768px) {
    .home-content {
      padding-top: var(--spacing-md);
    }
  }
</style>
