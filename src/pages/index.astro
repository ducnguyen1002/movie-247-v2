---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import HeroBanner from '../components/movie/HeroBanner.astro';
import MovieCarousel from '../components/movie/MovieCarousel.astro';
import { getNewUpdatedMovies, getMoviesByCategory, getImageUrl, type Movie } from '../lib/movieService';
import { MOVIE_GENRES } from '../lib/constants';

// Fetch data from API
const newMoviesRes = await getNewUpdatedMovies(1) as any;
const singleMoviesRes = await getMoviesByCategory('phim-le', 1, 12);
const seriesMoviesRes = await getMoviesByCategory('phim-bo', 1, 12);
const animationRes = await getMoviesByCategory('hoat-hinh', 1, 12);

// Extract items from responses
// Note: getNewUpdatedMovies returns { items } directly, while getMoviesByCategory returns { data: { items } }
const newMovies = newMoviesRes?.items || [];
const singleMovies = singleMoviesRes?.data?.items || [];
const seriesMovies = seriesMoviesRes?.data?.items || [];
const animationMovies = animationRes?.data?.items || [];

// Get featured movie for hero banner
const featuredMovie = newMovies[0];
---

<BaseLayout title="Movie247 - Xem Phim Online Chất Lượng Cao">
  <Header isTransparent={true} />
  
  <main>
    <!-- Hero Banner -->
    {featuredMovie && (
      <HeroBanner 
        id={featuredMovie.slug}
        title={featuredMovie.name}
        titleVi={featuredMovie.name}
        year={featuredMovie.year || 2024}
        rating={8.5}
        duration={featuredMovie.time || "N/A"}
        genres={featuredMovie.category?.map((c: any) => c.name) || []}
        synopsis=""
        backdrop={getImageUrl(featuredMovie.poster_url)}
      />
    )}

    <!-- Content Sections -->
    <div class="home-content">
      <!-- Streaming Logos -->
      <div class="logos-section">
        <div class="container">
          <div class="logos-bar">
            <span class="logo-item">Disney+</span>
            <span class="logo-item">NETFLIX</span>
            <span class="logo-item">HBO MAX</span>
            <span class="logo-item">PIXAR</span>
            <span class="logo-item">MARVEL</span>
            <span class="logo-item">STAR WARS</span>
          </div>
        </div>
      </div>

      <!-- Just Release -->
      {newMovies.length > 0 && (
        <MovieCarousel 
          title="Phim Mới Cập Nhật" 
          movies={newMovies}
          viewAllLink="/movies"
          useApi={true}
        />
      )}

      <!-- Phim Lẻ -->
      {singleMovies.length > 0 && (
        <MovieCarousel 
          title="Phim Lẻ" 
          movies={singleMovies}
          viewAllLink="/movies?category=phim-le"
          useApi={true}
        />
      )}

      <!-- Phim Bộ -->
      {seriesMovies.length > 0 && (
        <MovieCarousel 
          title="Phim Bộ" 
          movies={seriesMovies}
          viewAllLink="/tv-shows"
          useApi={true}
        />
      )}

      <!-- Genres Section -->
      <section class="genres-section">
        <div class="container">
          <div class="section-header">
            <h2 class="section-title">Khám Phá Theo Thể Loại</h2>
          </div>
          <div class="genres-scroll">
            {MOVIE_GENRES.slice(0, 10).map(genre => (
              <a href={`/movies?genre=${genre.slug}`} class="genre-pill">
                <span>{genre.name}</span>
              </a>
            ))}
          </div>
        </div>
      </section>

      <!-- Hoạt Hình -->
      {animationMovies.length > 0 && (
        <MovieCarousel 
          title="Phim Hoạt Hình" 
          movies={animationMovies}
          viewAllLink="/movies?category=hoat-hinh"
          useApi={true}
        />
      )}
    </div>
  </main>

  <Footer />
</BaseLayout>

<style>
  .home-content {
    padding-top: var(--spacing-xl);
  }

  /* Logos Section */
  .logos-section {
    margin-bottom: var(--spacing-2xl);
  }

  .logos-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-3xl);
    padding: var(--spacing-lg) 0;
    border-top: 1px solid var(--color-border);
    border-bottom: 1px solid var(--color-border);
  }

  .logo-item {
    font-size: var(--font-size-md);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-muted);
    opacity: 0.6;
    transition: opacity var(--transition-fast);
  }

  .logo-item:hover {
    opacity: 1;
  }

  /* Genres Section */
  .genres-section {
    padding: var(--spacing-2xl) 0;
  }

  .genres-scroll {
    display: flex;
    gap: var(--spacing-md);
    overflow-x: auto;
    padding-bottom: var(--spacing-sm);
    scrollbar-width: none;
  }

  .genres-scroll::-webkit-scrollbar {
    display: none;
  }

  /* Responsive */
  @media (max-width: 992px) {
    .logos-bar {
      gap: var(--spacing-xl);
      flex-wrap: wrap;
    }
  }

  @media (max-width: 768px) {
    .logos-bar {
      gap: var(--spacing-lg);
    }

    .logo-item {
      font-size: var(--font-size-sm);
    }
  }
</style>
