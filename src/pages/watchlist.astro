---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';

// Get translations
import { useTranslations } from '../lib/useTranslations';
const langCookie = Astro.cookies.get('language');
const { translations, lang } = useTranslations(langCookie?.value);
---

<BaseLayout title={`${translations.categories.yourWatchlist} - Movie247`}>
  <Header />
  
  <main class="watchlist-page">
    <div class="container">
      
      <!-- History Section -->
      <section class="list-section">
        <div class="section-header">
          <h1>{translations.nav.history || 'L·ªãch s·ª≠ xem'}</h1> <!-- Fallback if no translation key -->
          <button id="clear-history-btn" class="clear-btn">{translations.common.clear || 'X√≥a t·∫•t c·∫£'}</button>
        </div>
        
        <div class="watchlist-grid" id="history-grid">
           <!-- Rendered client-side -->
        </div>
        <div class="empty-message" id="history-empty" style="display: none;">
           <p>{translations.messages.noMoviesFound || 'B·∫°n ch∆∞a xem phim n√†o.'}</p>
        </div>
      </section>

      <div class="divider"></div>

      <!-- Watchlist Section -->
      <section class="list-section">
        <div class="section-header">
          <h1>{translations.categories.yourWatchlist}</h1>
          <span class="count-text" id="watchlist-count"></span>
        </div>

        <div class="watchlist-grid" id="watchlist-grid">
          <!-- Rendered client-side -->
        </div>
        
        <div class="watchlist-empty" id="watchlist-empty" style="display: none;">
          <div class="empty-icon">üìÅ</div>
          <h3>{translations.messages.noMoviesFound}</h3>
          <p>{translations.messages.tryAgain}</p>
          <a href="/movies" class="btn btn-primary">{translations.common.viewAll}</a>
        </div>
      </section>

    </div>
  </main>

  <Footer />
</BaseLayout>

<style>
  .watchlist-page {
    padding-top: calc(var(--header-height) + var(--spacing-2xl));
    min-height: 100vh;
    padding-bottom: var(--spacing-3xl);
  }

  .list-section {
    margin-bottom: var(--spacing-3xl);
  }

  .section-header {
    margin-bottom: var(--spacing-lg);
    border-bottom: 1px solid var(--color-border);
    padding-bottom: var(--spacing-md);
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
  }

  .section-header h1 {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
  }

  .count-text {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }
  
  .clear-btn {
    background: none;
    border: none;
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
    cursor: pointer;
    text-decoration: underline;
  }
  
  .clear-btn:hover {
    color: var(--color-primary);
  }

  .divider {
    height: 1px;
    background: var(--color-border);
    margin: var(--spacing-2xl) 0;
    opacity: 0.5;
  }

  /* Grid */
  .watchlist-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: var(--spacing-lg);
  }

  /* Empty State */
  .watchlist-empty, .empty-message {
    text-align: center;
    padding: var(--spacing-xl) 0;
    color: var(--color-text-muted);
  }
  
  .empty-message {
      font-style: italic;
  }

  .empty-icon {
    font-size: 4rem;
    margin-bottom: var(--spacing-md);
    opacity: 0.5;
  }

  .watchlist-empty h3 {
    font-size: var(--font-size-xl);
    margin-bottom: var(--spacing-xs);
  }

  .watchlist-empty p {
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-xl);
  }

  @media (max-width: 768px) {
    .watchlist-grid {
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: var(--spacing-md);
    }
  }
</style>

<script>
  import { getWatchlist, removeFromWatchlist, getHistory, removeFromHistory, clearHistory } from '../lib/watchlist';
  import { useTranslations } from '../lib/useTranslations';
  import { getImageUrl } from '../lib/movieService';

  const lang = document.documentElement.lang || 'vi';
  const { translations } = useTranslations(lang);

  // Watchlist DOM
  const watchlistGrid = document.getElementById('watchlist-grid');
  const watchlistEmpty = document.getElementById('watchlist-empty');
  const watchlistCount = document.getElementById('watchlist-count');
  
  // History DOM
  const historyGrid = document.getElementById('history-grid');
  const historyEmpty = document.getElementById('history-empty');
  const clearHistoryBtn = document.getElementById('clear-history-btn');

  function renderWatchlist() {
    if (!watchlistGrid || !watchlistEmpty || !watchlistCount) return;

    const items = getWatchlist();
    
    if (items.length === 0) {
      watchlistGrid.style.display = 'none';
      watchlistEmpty.style.display = 'block';
      watchlistCount.textContent = '';
      return;
    }

    watchlistGrid.style.display = 'grid';
    watchlistEmpty.style.display = 'none';
    watchlistCount.textContent = `${items.length} ${translations.nav.movies.toLowerCase()}`;

    watchlistGrid.innerHTML = items.map(item => createCardHtml(item, 'watchlist')).join('');
    attachRemoveHandlers(watchlistGrid, 'watchlist');
  }

  function renderHistory() {
     if (!historyGrid || !historyEmpty) return;
     
     const items = getHistory();
     
     if (items.length === 0) {
         historyGrid.style.display = 'none';
         historyEmpty.style.display = 'block';
         if(clearHistoryBtn) clearHistoryBtn.style.display = 'none';
         return;
     }
     
     historyGrid.style.display = 'grid';
     historyEmpty.style.display = 'none';
     if(clearHistoryBtn) clearHistoryBtn.style.display = 'block';
     
     historyGrid.innerHTML = items.map(item => createCardHtml(item, 'history')).join('');
     attachRemoveHandlers(historyGrid, 'history');
  }

  function createCardHtml(item: any, type: 'watchlist' | 'history') {
      const displayTitle = lang === 'vi' ? item.name : (item.origin_name || item.name);
      const isHistory = type === 'history';
      
      return `
        <div class="movie-card" data-slug="${item.slug}">
          <a href="/movies/${item.slug}" class="movie-card__poster">
            <img src="${getImageUrl(item.poster_url)}" alt="${displayTitle}" loading="lazy"/>
            
            <!-- Hover Popup -->
            <div class="movie-card__popup">
              <div class="popup-content">
                <h4 class="popup-title">${displayTitle}</h4>
                <div class="popup-meta">
                   ${item.year ? `<span class="popup-year">${item.year}</span>` : ''}
                   ${isHistory && item.duration ? `<span class="popup-duration">${item.duration}</span>` : ''}
                </div>
                ${item.overview ? `<p class="popup-desc">${item.overview}</p>` : ''}
                
                <div class="popup-actions">
                  <button class="popup-btn play-btn-small">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <polygon points="5 3 19 12 5 21 5 3"/>
                    </svg>
                    Xem ngay
                  </button>
                  <!-- No watchlist button here as per request -->
                </div>
              </div>
            </div>

            <div class="movie-card__overlay">
               <!-- Basic overlay content if needed, but popup takes precedence on hover -->
            </div>
            ${isHistory && item.duration ? `<div class="duration-badge">${item.duration}</div>` : ''}
          </a>
          <div class="movie-card__info">
            <h3 class="movie-card__title">${displayTitle}</h3>
            <div class="movie-card__meta">
              <span>${item.year || ''}</span>
              <button class="remove-btn" data-slug="${item.slug}" data-type="${type}" title="${translations.common.removeWatchlist}">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
              </button>
            </div>
             ${isHistory ? `<div class="history-time" style="font-size: 10px; color: var(--color-text-muted); margin-top: 4px;">Xem: ${new Date(item.watchedAt).toLocaleDateString('vi-VN')}</div>` : ''}
          </div>
        </div>
      `;
  }

  function attachRemoveHandlers(container: HTMLElement, type: 'watchlist' | 'history') {
      container.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const slug = (btn as HTMLElement).dataset.slug;
          if (slug) {
            if (type === 'watchlist') {
                removeFromWatchlist(slug);
                // Toast logic
                 if (typeof (window as any).showToast === 'function') {
                    (window as any).showToast(translations.messages.removedFromWatchlist, 'info');
                }
            } else {
                removeFromHistory(slug);
            }
            // Re-render handled by event listeners
          }
        });
      });
  }
  
  // Clear History
  clearHistoryBtn?.addEventListener('click', () => {
      if(confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ xem kh√¥ng?')) {
          clearHistory();
      }
  });

  // Initial render
  renderWatchlist();
  renderHistory();

  // Listen for updates
  window.addEventListener('watchlist-updated', renderWatchlist);
  window.addEventListener('history-updated', renderHistory);
</script>

<style is:global>
  /* Reuse MovieCard styles */
  .watchlist-grid .movie-card {
    display: flex;
    flex-direction: column;
  }

  .watchlist-grid .movie-card__poster {
    position: relative;
    aspect-ratio: 2/3;
    overflow: hidden;
    border-radius: var(--radius-md);
    background: var(--color-surface);
  }

  .watchlist-grid .movie-card__poster img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-slow);
  }

  .watchlist-grid .movie-card__overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .watchlist-grid .movie-card__poster:hover .movie-card__overlay {
    opacity: 1;
  }

  .watchlist-grid .movie-card__poster:hover img {
    transform: scale(1.05);
  }

  .watchlist-grid .play-btn {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-primary);
    border-radius: var(--radius-full);
    color: var(--color-background);
  }
  
  .duration-badge {
      position: absolute;
      bottom: 6px;
      right: 6px;
      background: rgba(0,0,0,0.8);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: bold;
  }

  .watchlist-grid .movie-card__info {
    padding: var(--spacing-sm) 0;
  }

  .watchlist-grid .movie-card__title {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    margin-bottom: 4px;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .watchlist-grid .movie-card__meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }

  /* New Popup Styles */
  .watchlist-grid .movie-card__popup {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 60%, rgba(0,0,0,0.2) 100%);
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-normal);
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: var(--spacing-sm);
    z-index: 10;
  }

  .watchlist-grid .movie-card:hover .movie-card__popup {
    opacity: 1;
    visibility: visible;
  }
  
  .watchlist-grid .popup-content {
      transform: translateY(10px);
      transition: transform var(--transition-normal);
      width: 100%;
  }
  
  .watchlist-grid .movie-card:hover .popup-content {
      transform: translateY(0);
  }

  .watchlist-grid .popup-title {
    font-size: var(--font-size-sm);
    font-weight: bold;
    color: white;
    margin-bottom: 4px;
    line-height: 1.2;
  }

  .watchlist-grid .popup-meta {
    display: flex;
    gap: 8px;
    font-size: 11px;
    color: var(--color-text-secondary);
    margin-bottom: 6px;
    align-items: center;
  }

  .watchlist-grid .popup-desc {
    font-size: 11px;
    color: var(--color-text-muted);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 8px;
  }

  .watchlist-grid .popup-actions {
    display: flex;
    gap: 8px;
  }

  .watchlist-grid .popup-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    border-radius: var(--radius-full);
    border: none;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all var(--transition-fast);
  }

  .watchlist-grid .play-btn-small {
    flex: 1;
    background: white;
    color: black;
    padding: 6px 12px;
  }
  
  .watchlist-grid .play-btn-small:hover {
    background: var(--color-primary);
    color: white;
  }

  .watchlist-grid .remove-btn {
    padding: 4px;
    color: var(--color-text-muted);
    transition: color var(--transition-fast);
    background: none;
    border: none;
    cursor: pointer;
  }

  .watchlist-grid .remove-btn:hover {
    color: #ff4d4d;
  }
</style>
