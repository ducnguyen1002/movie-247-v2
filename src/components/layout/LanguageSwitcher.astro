---
import { useTranslations } from '../../lib/useTranslations';

const langCookie = Astro.cookies.get('language');
const { lang } = useTranslations(langCookie?.value);
---

<button class="language-switcher" id="languageSwitcher" aria-label="Switch language">
  <span class="language-switcher__flag">
    {lang === 'vi' ? 'ðŸ‡»ðŸ‡³' : 'ðŸ‡ºðŸ‡¸'}
  </span>
  <span class="language-switcher__label">
    {lang === 'vi' ? 'VI' : 'EN'}
  </span>
  <svg class="language-switcher__arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <polyline points="6 9 12 15 18 9"/>
  </svg>
</button>

<div class="language-dropdown" id="languageDropdown">
  <button class={`language-option ${lang === 'vi' ? 'active' : ''}`} data-lang="vi">
    <span class="language-option__flag">ðŸ‡»ðŸ‡³</span>
    <span class="language-option__label">Tiáº¿ng Viá»‡t</span>
    {lang === 'vi' && (
      <svg class="language-option__check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
    )}
  </button>
  <button class={`language-option ${lang === 'en' ? 'active' : ''}`} data-lang="en">
    <span class="language-option__flag">ðŸ‡ºðŸ‡¸</span>
    <span class="language-option__label">English</span>
    {lang === 'en' && (
      <svg class="language-option__check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
    )}
  </button>
</div>

<style>
  .language-switcher {
    display: flex;
    align-items: center;
    gap: var(--spacing-2xs);
    padding: 6px 10px;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .language-switcher:hover {
    background: var(--color-surface-hover);
    border-color: var(--color-text-muted);
  }

  .language-switcher__flag {
    font-size: 16px;
    line-height: 1;
  }

  .language-switcher__label {
    font-weight: var(--font-weight-medium);
  }

  .language-switcher__arrow {
    opacity: 0.6;
    transition: transform var(--transition-fast);
  }

  .language-switcher.open .language-switcher__arrow {
    transform: rotate(180deg);
  }

  .language-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: var(--spacing-2xs);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all var(--transition-fast);
    z-index: 100;
    min-width: 140px;
    overflow: hidden;
  }

  .language-dropdown.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .language-option {
    width: 100%;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    background: transparent;
    border: none;
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-align: left;
  }

  .language-option:hover {
    background: var(--color-surface-hover);
    color: var(--color-text-primary);
  }

  .language-option.active {
    color: var(--color-primary);
  }

  .language-option__flag {
    font-size: 18px;
    line-height: 1;
  }

  .language-option__label {
    flex: 1;
    font-weight: var(--font-weight-medium);
  }

  .language-option__check {
    color: var(--color-primary);
  }
</style>

<script>
  const switcher = document.getElementById('languageSwitcher');
  const dropdown = document.getElementById('languageDropdown');
  const options = dropdown?.querySelectorAll('.language-option');

  // Toggle dropdown
  switcher?.addEventListener('click', (e) => {
    e.stopPropagation();
    switcher.classList.toggle('open');
    dropdown?.classList.toggle('show');
  });

  // Close on click outside
  document.addEventListener('click', () => {
    switcher?.classList.remove('open');
    dropdown?.classList.remove('show');
  });

  // Handle language selection
  options?.forEach(option => {
    option.addEventListener('click', (e) => {
      e.stopPropagation();
      const lang = (option as HTMLElement).dataset.lang;
      
      if (lang) {
        // Set cookie for SSR
        document.cookie = `language=${lang};path=/;max-age=31536000`;
        
        // Also set in localStorage for client-side
        localStorage.setItem('language', lang);
        
        // Update HTML lang attribute
        document.documentElement.setAttribute('lang', lang);
        
        // Reload page to apply new language
        window.location.reload();
      }
    });
  });
</script>
